<!DOCTYPE html>
<html>
<head>
    <script src="../Scripts/jquery-2.2.0.js"></script>

    <script src="../Scripts/papaparse.js"></script>
    <script src="../Scripts/papaparse.min.js"></script>

    <script src="../Scripts/angular.js"></script>

    <script src="../Scripts/bootstrap.js"></script>
    <link href="../Content/bootstrap.css" rel="stylesheet" />

    <script src="../Scripts/angular-ui/ui-bootstrap-tpls.js"></script>
    <script src="../Scripts/angular-animate.js"></script>
    
    <title>DevTest</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
</head>
<body ng-app="restApp" ng-controller="restCtrl">
    <div class="row well-lg">
        <div class="col-lg-2"></div>
        <div class="col-lg-8">
            <div class="row well" ng-show="show">
                <div class="col-lg-6">
                    <table>
                        <tr>
                            <td>Name:</td>
                            <td><input type="text" name="Name" ng-model="sreach.Name" />     </td>
                        </tr>
                        <tr>
                            <td>Address:</td>

                            <td>  <input type="text" name="Address" ng-model="sreach.Address" />  </td>
                        </tr>
                        <tr>
                            <td>Latitude:</td>
                            <td><input type="text" name="Latitued" ng-model="sreach.Latitude" />  </td>
                        </tr>
                    </table>
                </div>
                <div class="col-lg-6">
                    <table>
                        <tr>
                            <td>Longitude:</td>
                            <td><input type="text" name="Sort" ng-model="sreach.Longitude" /></td>

                        </tr>
                        <tr>
                            <td>Sort:</td>

                            <td>  <input type="text" name="Address" ng-model="sreach.Sort" />  </td>
                        </tr>
                        <tr>
                            <td>Cuisine:</td>
                            <td><input type="text" name="Cuisin" ng-model="sreach.Cuisine" /></td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="row well" ng-show="bulkUpload" >
                <input type="file" name="fileUpload" id="fileUpload"  accept=".csv" ng-model="fileUpload"  onchange="angular.element(this).scope().Upload(this)"/>
            </div>            
            <button type="button" class="btn btn-default" ng-click="OpenAddModal(Restaurants)"><span class="glyphicon glyphicon-plus"> Add</span></button>
            <button type="button" class="btn btn-default" ng-click="BulkUpload()" ><span class="glyphicon glyphicon-upload"> Import</span></button>
            <button type="button" class="btn btn-default" ng-click="Download()"><span class="glyphicon glyphicon-download"> Export</span></button>
            <button type="button" class="btn btn-default" ng-click="Sreach()"><span class="glyphicon glyphicon-search"> Sreach</span></button>
        </div>
        <div class="col-lg-2"></div>
    </div>
    <div class="row">
        <div class="col-lg-2"></div>
        <div class="col-lg-8">
            <table class="table table-responsive">
                <thead>
                    <tr>
                        <th class="text-center"><a ng-click="SortBy('Name')" role="button" name="Name">Name</a> <span ng-show="order==='Name'" class="glyphicon glyphicon-sort-by-attributes{{alt}}"></span></th>
                        <th class="text-center"><a ng-click="SortBy('Address')" role="button" name="Address">Address</a> <span ng-show="order==='Address'" class="glyphicon glyphicon-sort-by-attributes{{alt}}"></span></th>
                        <th class="text-center">Coords</th>
                        <th class="text-center"><a ng-click="SortBy('Latitude')" role="button" name="Latitude">Latitude</a> <span ng-show="order==='Latitude'" class="glyphicon glyphicon-sort-by-attributes{{alt}}"></span></th>
                        <th class="text-center"><a ng-click="SortBy('Longitude')" role="button" name="Longitude">Longitude</a> <span ng-show="order==='Longitude'" class="glyphicon glyphicon-sort-by-attributes{{alt}}"></span></th>
                        <th class="text-center"><a ng-click="SortBy('Sort')" role="button" name="Sort">Sort</a> <span ng-show="order==='Sort'" class="glyphicon glyphicon-sort-by-attributes{{alt}}"></span></th>
                        <th class="text-center"><a ng-click="SortBy('Cuisine')" role="button" name="Cuisine">Cuisine</a> <span ng-show="order==='Cuisine'" class="glyphicon glyphicon-sort-by-attributes{{alt}}"></span></th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tr ng-repeat="item in Restaurants | filter:sreach as results" class="" >
                    <td class="text-center"> {{item.Name}}</td>
                    <td class="text-center"> {{item.Address}}</td>
                    <td class="text-center"> {{item.Coords}}</td>
                    <td class="text-center"> {{item.Latitude}}</td>
                    <td class="text-center"> {{item.Longitude}}</td>
                    <td class="text-center"> {{item.Sort}}</td>
                    <td class="text-center"> {{item.Cuisine}}</td>
                    <td class="text-center">
                        <a ng-click="Delete(item.ID)" role="button" class="btn  btn-link">DELETE</a>
                        <a ng-click="Set(item)" role="button" class="btn btn-link">UPDATE</a>
                    </td>
                </tr>
                <tr ng-if="results.length==0">
                    <td>
                         <strong>not result found...</strong>
                    </td>
                </tr>
            </table>
        </div>
        <div class="col-lg-2"></div>
           
    </div>
</body>

</html>

<script>           
    var myApp = angular.module('restApp', ['ui.bootstrap', 'ngAnimate']);   
    myApp.controller('restCtrl', function ($scope, $http, $uibModal, $filter) {
        $scope.reverse = false;
        $scope.alt = '';
        $scope.show = false;
        $scope.bulkUpload = false;
        $http.get("../api/Restaurant").then(function (response) {
            $scope.Restaurants = response.data;
        });
        $scope.Delete = function (id) {
            $http.delete("../api/Restaurant/" + id).then(
                function () {
                    $http.get("../api/Restaurant").then(function (response) { $scope.Restaurants = response.data; });
                }, function () { });
        }
        $scope.OpenAddModal = function (items) {
            $uibModal.open({
                templateUrl: 'AddModal.html',
                controller: DefaultValue,
                resolve: {
                    restaurants: function () {
                        return items;
                    }
                }
            });
        }
        $scope.Set = function (item) {
            $uibModal.open({
                templateUrl: 'EditeModal.html',
                controller: value,
                resolve: {
                    rest: function () {
                        return item;
                    }
                }
            });
        }
        $scope.SortBy = function (order) {            
            $scope.order = order;
            $scope.reverse = ($scope.reverse === false) ? !$scope.reverse : false;
            $scope.alt = ($scope.reverse === false) ? '-alt' : '';
            $scope.Restaurants = $filter('orderBy')($scope.Restaurants, order, $scope.reverse);
        }
        $scope.Sreach = function ()
        {
            $scope.show=($scope.show)?!$scope.show : true;
        }
        $scope.BulkUpload = function ()
        {
            $scope.bulkUpload = ($scope.bulkUpload) ? !$scope.bulkUpload : true;
        }
        $scope.Upload = function (file)
        {                         
            Papa.parse(file.files[0], {
                header: true,
                dynamicTyping: true,
                complete: function (results) {
                    $http.patch("../api/Restaurant", results.data).then(function (response)
                    {
                        file.value = '';
                        $scope.Restaurants = response.data;
                        $scope.bulkUpload=false;
                    });
                }
            });                                    
        }
        $scope.Download = function ()
        {           
            $http.get("../api/Restaurant").then(function (response) {                                                
                for (var i = 0; i < response.data.length; i++) {
                    delete response.data[i].ID;                    
                }                
                var csvString = Papa.unparse(response.data);
                var blob = new Blob([csvString]);
                if (window.navigator.msSaveOrOpenBlob)
                    window.navigator.msSaveBlob(blob, "filename.csv");
                else {
                    var a = window.document.createElement("a");
                    a.href = window.URL.createObjectURL(blob, { type: "text/plain" });
                    a.download = "filename.csv";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
            });            
        }
    });
         
    var DefaultValue = function ($scope, $uibModalInstance, restaurants, $http) {        
        $scope.Close = function () { $uibModalInstance.dismiss('cancel'); }
        $scope.Add = function () {
            $http.post("../api/Restaurant", $scope.rest).then(
                function (response) {
                    $uibModalInstance.dismiss('cancel');
                    restaurants.push(response.data);
                });
        }
    }

    var value = function ($scope, $uibModalInstance, rest, $http) {
        $scope.rest = rest;
        $scope.Save = function () {
            $http.put("../api/Restaurant", $scope.rest).then(function () { $uibModalInstance.dismiss('cancel'); });

        }
        $scope.Close = function () {
            $uibModalInstance.dismiss('cancel');
        }
    }
</script>

